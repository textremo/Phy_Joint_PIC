clear;
clc;

%% folders & files
pFolder = "./_data/Samples/Whole_CE/";
pFile = pFolder + "test_embedded_iter_n.mat";
% create the folder if not exist
if ~exist(pFolder, 'dir')
    mkdir(pFolder);
end


%% Data
iter_num = 10;
M_mod = 4;
M_bits = log2(M_mod);
constel = qammod(0: M_mod-1, M_mod, 'UnitAveragePower',true);
SNR_p = 30; % dB
SNR_d = 18; % dB
No = 10^(-SNR_d/10);
pil_pow = 10^((SNR_p - SNR_d)/10);
sig_pow = 10^(SNR_d/10);
pil_thr = 3*sqrt(No);
M = 8;
N = 8;
p = 3;
kmax = 1;
lmax = 2;
% pilot
pk_len = 1;
pl_len = 1;
gkn_len = 2*kmax;
gkp_len = 2*kmax;
gln_len = lmax;
glp_len = lmax;
% CSI
his = [-0.245001294484229 + 0.190566910093579i	-0.0966735321794913 - 0.0195910978032867i	0.159574806792314 - 0.0563555055791835i	0.299959634256755 - 0.0628175424162719i	-0.322634497319953 - 0.0874996333904274i	0.363920822533598 + 0.00665269873273877i];
lis = [0,0,0,1,1,1];
kis = [-1,0,1,-1,0,1];
noise = [0.0232702523093328 + 0.0291147047952844j, ...
-0.0838105639369993 + 0.0963754602845372j, ...
-0.0144512135240256 + 0.0895604507503948j, ...
-0.0130017060762535 - 0.0579434614501421j, ...
-0.0473593705680734 + 0.0228830027841587j, ...
0.149739969756641 - 0.0840680113986243j, ...
-0.0779569618809725 - 0.117664913056458j, ...
-0.0430689591301919 + 0.0823275140430543j, ...
-0.0633822672849740 + 4.43753823732121e-06j, ...
-0.104527758907397 - 0.00488885264782208j, ...
-0.0171130598815029 + 0.0811080658981524j, ...
-0.0243975864931917 + 0.0529295253575932j, ...
0.136206243635791 + 0.0311747227406725j, ...
-0.0221680504880709 + 0.111296701171417j, ...
-0.0947357135233807 + 0.0827693644114438j, ...
0.142738918154823 + 0.0213435979654360j, ...
0.109910482743841 - 0.0614555792098738j, ...
-0.0204412248637020 - 0.0580009595842119j, ...
-0.134077537934134 + 0.106120276186635j, ...
-0.0395805323756321 - 0.143484286234927j, ...
-0.0138817882842239 - 0.00217758862395438j, ...
0.0245754495297625 - 0.173485341958139j, ...
-0.0232486492176689 + 0.0908441919425605j, ...
0.0394731834818925 + 0.0767095281578259j, ...
0.0348862146507500 + 0.000103448055297034j, ...
-0.111334772886539 - 0.00630589114127600j, ...
-0.0843869784778682 - 0.221327675818373j, ...
-0.0659728713767601 + 0.0517356518926620j, ...
-0.0452056489634764 - 0.195169393639418j, ...
-0.0285374615542937 - 0.206461102678686j, ...
0.00110998744804231 + 0.00711565649143101j, ...
-0.269655760161541 - 0.0844332740535138j, ...
-0.0406832009155512 + 0.0366306768516332j, ...
0.110602098103470 + 0.0602642051718237j, ...
-0.0949571927258897 + 0.0763548962060537j, ...
0.0831199857624179 - 0.0615266187292104j, ...
0.0311853897195222 + 0.0400033576503887j, ...
-0.00258207769978796 + 0.00895832746597655j, ...
0.0162417951730554 + 0.0735363130904691j, ...
-0.139320456225114 + 0.0477284188605471j, ...
-0.00752565965099373 + 0.0799295514131313j, ...
0.142782453347436 - 0.0117450390186809j, ...
0.00875486673173156 - 0.0131037955463367j, ...
0.00368305712698890 + 0.0897114539858055j, ...
-0.0653553449860398 - 0.189046682811076j, ...
-0.00274302190113208 - 0.0449180141704706j, ...
0.0206834078197197 - 0.113107643958993j, ...
0.0379567941912687 - 0.0340574962021082j, ...
-0.0331872364388278 + 0.0577450838278308j, ...
-0.0210490616231696 + 0.0735057928340357j, ...
0.180147889296562 - 0.0903497447135833j, ...
-0.201037472552102 - 0.0419343937568633j, ...
0.198464071906664 + 0.0121978816127849j, ...
0.0300497415742506 - 0.0259815228961344j, ...
0.0890248836963355 + 0.0268677276953480j, ...
-0.148143038838542 + 0.0356016404060644j, ...
-0.0525245639327905 - 0.0827846846961989j, ...
-0.0247531243644721 - 0.0157413364767252j, ...
0.0376299266108439 - 0.189797930287804j, ...
-0.148680380196042 + 0.101959491934736j, ...
0.0419846375680045 - 0.0560013258543150j, ...
-0.107967014382991 - 0.107166086126058j, ...
0.00589220300149026 - 0.0226060210181085j, ...
0.0580723751787006 - 0.127177386090639j].';


%% Tx
xDD_idx = [2,2,4,4,1,3,2,2,3,4,2,4,2,3,3,3,3,3,1,1,4,1,1,3,4,3,1,2,2,4,1,4,3,2,1,2,2,1,3].';
xDD = constel(xDD_idx);
rg = OTFSResGrid(M, N);
rg.setPulse2Recta();
rg.setPilot2Embed();
rg.setPilot2Center(pl_len, pk_len);
rg.setGuard(gln_len, glp_len, gkn_len, gkp_len);
rg.map(xDD, 'pilots_pow', pil_pow);
XdLocs = rg.getContentDataLocsMat();
Xp = rg.getPilotsMat();
% channel - ideal
otfs = OTFS();
otfs.setPulse2Recta();

otfs.setChannel(his, lis, kis);
[his_acc, lis_acc, kis_acc] = otfs.getCSI();
otfs.modulate(rg);
otfs.passChannel(noise);
% Rx
rg_rx = otfs.demodulate();
[y, hiEsts, liEsts, kiEsts] = rg_rx.demap("threshold", pil_thr);
Y_DD = rg_rx.getContent();

%% Tests
jpic = JPIC(constel, "iter_num", iter_num);
% Tests - Recta - OTFS(Embed)
jpic.setPul2Recta();
jpic.setMod2OtfsEM(M, N, "Xp", Xp, "XdLocs", XdLocs);
[x, H_DD] = jpic.detect(Y_DD, lmax, kmax, No, "sym_map", true);
diff_x = abs(x - xDD.');
assert(sum(abs(diff_x), "all") == 0);

%% save
if ~exist(pFile, 'file')
    save(pFile);
end

